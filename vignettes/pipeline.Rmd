---
title: "A GC-MS filtering pipeline with bouquet"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{A GC-MS filtering pipeline with bouquet}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  comment = "  ", message=F, warning=F,
  fig.width=7, fig.height=6, highlight=FALSE
)
requireNamespace("magrittr", quietly = TRUE)
requireNamespace("vegan", quietly = TRUE)
```

The open-source R package `bouquet` facilitates easy and transparent preprocessing and GC-MS datasets. The package flexibly accepts integrated and identified peaks from a set of chromatograms and performs customizable filtering steps. Using internal or external standards, emission rates can be quantified and standardized by a measure of biomass. Visualizations of statistics for each compound help determine filtering thresholds. Finally, the filtered dataset can be augmented with information from freely online chemical databases.

To begin, install the package from GitHub using the commented lines and load the magrittr package for the pipe operator. After loading bouquet, help for each function is available by typing `?function_name`. Bugs or feature requests can be submitted on [GitHub](https://github.com/jmpowers/bouquet/issues).

```{r libraries}
# install.packages("remotes")
# remotes::install_github("jmpowers/bouquet", build_vignettes = TRUE)
library(bouquet)
library(magrittr)
```

The example dataset `GCMSfloral` is provided with the package and it contains 128 floral samples and 16 ambient controls. The floral samples were taken from four types of hybrid crosses at two times of day. The information about each sample and control is given in the `GCMSmetadata` table for this example, but would normally be imported from a spreadsheet. `load_metadata()` identifies the important columns that will be used later, and standardizes their names. The `group` argument indicates the column(s) with experimental groups, and the type column specifies whether the row represents a floral sample or an ambient or vegetative control.

```{r load_metadata}
data(GCMSfloral)
metadata <- load_metadata(GCMS_metadata, date = "SampleDate", 
                          sample = "Filename", group = c("Cross", "Time"), 
                          type = "Type", amount = "Flrs")

str(metadata, vec.len=1)
```

In this example, `GCMS_output` contains the retention times, integrated areas, and compound identifications for each peak in each floral and ambient control sample. This table can be generated by picking and integrating peaks and performing a batch search against a mass spectral library, using software provided by the instrument manufacturer or freely available software such as AMDIS. `load_longdata()` standardizes the column names and the match scores (similarity scores) for the top library hit. `make_sampletable()` reshapes the data into a table of peak areas organized with samples in rows and compounds in columns.

```{r load_longdata}
longdata <- load_longdata(GCMS_output, sample = "Sample", RT = "RT", 
                          name = "Name", area = "Area", 
                          match = "Match", maxmatch=100)

sampletable <- make_sampletable(longdata, metadata)

dim(sampletable)
```

`make_chemtable()` calculates descriptive statistics for each compound, including the mean and maximum peak area across samples, the mean and variance of the match score and retention time, and the count and frequency of occurrence in controls, samples, and each experimental group. Eleven `filter_*()` functions have been implemented that append a column with the verdict for each compound; view the complete listing with `help(package = "bouquet")`. The example here uses filters for retention time, match score, minimum frequency in each experimental group, a manual contaminant list, and maximum peak area across all samples. The last filter performs t-tests of the compound peak areas observed in samples vs. ambient controls and corrects for multiple comparisons using the false discovery rate method. Alternatively, `filter_ambient_presence()` excludes any compounds found in controls, and `filter_ambient_ratio()` and `filter_leaf_ratio()` require the mean area across samples to exceed the mean area in ambient or vegetative controls by a specified ratio. To compare samples to controls taken on the same date, use `filter_ambient_date()`. To tally the number of filters that each compound passes, use `combine_filters()`, and then leave the filter_final column as the default (compound must meet all specified filters), or customize it with your own logical combination of the filter columns. For example, setting `chemtable$filter_final <- chemtable$filters_passed >= 5 & chemtable$filter_RT=="Ok"` would require the retention time filter to be met and at least five of the applied filters.

```{r chemtable}
chemtable <- 
  make_chemtable(longdata, metadata) %>% 
  filter_RT(4, 15) %>% 
  filter_match(0.8) %>% 
  filter_freq(0.2, group = TRUE) %>% 
  filter_contaminant(cont.list = "Caprolactam") %>% 
  filter_area(min_maximum = 20000) %>%
  filter_ambient_ratio(sampletable, metadata, ratio = 4) %>% 
  filter_ambient_ttest(sampletable, metadata, 
                       alpha = 0.05, adjust = "fdr") %>%
  combine_filters()

with(chemtable, hist(filters_passed, main = "Number of filters passed"))
chemtable <- within(chemtable,
                    filter_final <- (filter_ambient_ratio == "OK" | filter_ambient_ttest == "OK") &
                      filters_passed >= 10)
str(chemtable, vec.len=1)
```

```{r saveout, eval = FALSE, include = FALSE}
#save.image(file = "./data/GCMSfloral.rda")
```

Visualize the filtering criteria using `plot_filters()` that creates a plot of compound occurence and peak areas, including text showing how areas compare in samples versus controls.

```{r plot_filters, fig.width=12, fig.height=8}
plot_filters(chemtable, fontsize=2.5)
```

To cut out the compounds that did not meet filter_final, use `prune_sampletable()`.

```{r prune}
finaltable <- prune_sampletable(sampletable, chemtable, metadata)
finalmetadata <- subset(metadata, type == "floral")

dim(finaltable)
```

The filtered table is now ready for analysis. As an example, with the vegan package you can conduct a PERMANOVA for the effect of hybrid cross, run a CAP ordination, and plot a heatmap.

```{r analysis}
library(vegan)
(permanova <- adonis2(finaltable ~ Cross, data = finalmetadata))

(cap <- capscale(finaltable ~ Cross, data = finalmetadata, 
                 distance = "bray"))
plot(cap, type = "n", 
     main = paste("CAP of", ncol(finaltable), "volatiles in", 
                  nrow(finaltable), "samples vs. cross type"))
legend("bottomright", levels(finalmetadata$Cross), 
       col = 2:5, pch = 19, title = "Cross")
points(cap, col = as.integer(finalmetadata$Cross)+1, pch = 19)
text(cap, display = "species", col="grey50")
text(cap, display = "cn", labels=levels(finalmetadata$Cross))


heatmap(as.matrix(finaltable)^(1/4), 
        scale = "none", distfun = vegdist,
        cexCol = 1, margins = c(15, 0), labRow = NA,
        col=colorRampPalette(c("white","darkblue"))(256),
        RowSideColors = as.character(as.integer(finalmetadata$Cross)+1))
legend("bottomleft", levels(finalmetadata$Cross), title = "Cross",
       col = 2:5, pch = 19, inset=c(0,-0.2),  xpd=T)
```
